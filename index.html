<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="./assets/backgrounds/img2.jpg" type="image/x-icon">
    <title>维词危机Ⅲ:时空旅途</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: "本地";
            font-size: 3vh;
        }

        html,
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        @font-face {
            font-family: "本地";
            src: url("./assets/font/font.ttf");

        }

        #homepage {
            position: fixed;
            z-index: 32000;
            transition: 0.8s;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            background-position: center bottom;
            background-size: cover;
        }

        #startgame {
            position: fixed;
            opacity: 0.1;
            font-size: 5vh;
            animation: textshine 3s infinite;
            color: #fff;
            bottom: 13vh;
            width: 100vw;
            text-align: center;
        }

        #loadingtips {
            position: fixed;
            opacity: 0;
            font-size: 2.5vh;
            color: #fff;
            bottom: 2vh;
            width: 100vw;
            text-align: left;
            padding: 12px;
        }

        .textshine {
            opacity: 0.1;
            animation: textshine 3s infinite;
        }

        @keyframes textshine {
            0% {
                opacity: 0.1;
            }

            50% {
                opacity: 1.0;
            }
        }

        #joystick-container {
            position: fixed;
            left: 12vh;
            bottom: 13vh;
            width: 30vh;
            height: 30vh;
            z-index: 10001;
        }

        #joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(100, 100, 100, 0.5);
            border-radius: 50%;
            position: absolute;
        }

        #joystick-head {
            transition: transform 0.1s ease-out;
            width: 40%;
            height: 40%;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
        }

        .btn0 {
            position: absolute;
            top: 45vh;
            left: 65vw;
            width: 20vw;
            color: #fff;
            padding: 9px;
            background-color: rgb(99, 99, 99, 0.5);
            transition: 0.3s;
            border-bottom: 3px solid #74A5FF;
        }

        .btn0:active {
            background-color: rgb(99, 99, 99, 0.3)
        }

        .print {
            z-index: 10049;
            position: fixed;
            text-align: center;
            font-size: 80%;
            padding: 8px;
            width: 100vw;
            height: 8vh;
            top: 15vh;
            left: 0;
            background-image: linear-gradient(to right, #2EAFFF, #468DFF, #F774FF);
            color: #fff;
        }

        .actions {
            z-index: 10002;
            position: absolute;
            top: 0;
            right: 0;
            width: 100vh;
            height: 12vh;
        }

        .actionObjects {
            float: right;
            width: 9vh;
            height: 9vh;
            margin: 2vh;
            background-size: 100% 100%;
        }

        .bagLayout {
            position: fixed;
            z-index: 22999;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            padding: 10vh;
            display: flex;
            justify-content: space-around;
            background: rgb(64, 64, 64, 0.8);
        }

        .bagContentsLab {
            position: fixed;
            display: flex;
            justify-content: space-around;
            top: 0;
            left: 0;
            width: 100vw;
            height: 18vh;
            color: #fff;
            background-image: linear-gradient(to rigth, #08f, #9cf);
        }

        .bagContentsLab>.lab {
            text-align: center;
        }

        .bagContentsParent {
            display: grid;
            grid-template-columns: 8vw 8vw 8vw 8vw 8vw 9vw 8vw 8vw 8vw;
            grid-template-rows: 8vw 8vw 8vw 8vw 8vw;
            grid-gap: 1vh;
        }

        .bagContent {
            background: rgb(0, 0, 0, 0.9);

        }

        #obtainment {
            position: fixed;
            left: 3vw;
            top: 36vh;
            z-index: 22999;
        }

        .obtainContent {
            background-image: linear-gradient(to right, #8B9AFF, rgb(0, 0, 0, 0));
            color: #fff;
            padding: 5px;
            width: 25vh;
            height: 7vh;
            font-size: 3vh;
        }

        #playerHp {
            z-index: 10003;
            position: fixed;
            bottom: 8vh;
            text-align: center;
            color: #fff;
            background-image: linear-gradient(to right, #9cf, #08f);
            width: 80vw;
            height: 2vh;
            border-radius: 5px;
            left: 0;
            right: 0;
            margin: auto;
            font-size: 1.5vh;

        }


        #Weici {
            z-index: 25000;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #fff;
            padding-top: 30px;
        }

        #wWord {
            position: absolute;
            top: 14vh;
            left: 0;
            width: 100%;
            text-align: center;
            height: 20vh;
        }

        #wOptions {
            position: absolute;
            font-size: 8vh;
            width: 60vw;
            left: 0;
            right: 0;
            margin: auto;
            bottom: 6vh;
            height: 56vh;
        }

        #wOptions>.block {
            border: 1px solid rgb(222, 222, 222);
            padding: 2vh 5vh;
            font-size: 5vh;
            margin: 30px;
            border-radius: 12px;
        }

        #wBoard {
            font-size: 210%;
            z-index: 25001;
            text-align: center;
            position: fixed;
            transition: 1s;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: #fff;
        }

        #options {
            transition: 1s;
            position: fixed;
            width: 50vw;
            height: 100vh;
            overflow: auto;
            top: 0;
            right: 0;
            background: rgb(255, 255, 255, 0.6);
        }

        #options>div {
            color: #fff;
            transition: 0.8s;
            font-size: 3vh;
            padding: 16px;
            margin: 12px 30px;
            border-radius: 12px;
            background: #08f;
        }

        #options>div:active {
            background: #9cf;
        }


        #musicAmusement {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .game-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .score-container {
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }

        .combo-container {
            font-size: 22px;
            color: #ffcc00;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }

        .game-area {
            position: relative;
            flex: 1;
            background: rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .judgment-line {
            position: absolute;
            bottom: 20vh;
            width: 100%;
            height: 2.5vh;
            background: linear-gradient(to right, transparent, #ff3366, transparent);
            box-shadow: 0 0 10px #ff3366, 0 0 20px rgba(255, 51, 102, 0.5);
            z-index: 5;
        }

        .note {
            position: absolute;
            width: 14vh;
            height: 14vh;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            transition: transform 0.1s;
        }

        .note-inner {
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #9cf, #08f);
            box-shadow: 0 0 15px #A2AEFF;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            animation: pulse 1.2s infinite alternate;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1.05);
            }
        }

        .controls {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .start-button {
            padding: 15px 40px;
            background: linear-gradient(to right, #ff3366, #ff6699);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 51, 102, 0.4);
            transition: all 0.2s;
        }

        .start-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(255, 51, 102, 0.4);
        }

        .judgment-effect {
            position: absolute;
            width: 119px;
            height: 119px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            pointer-events: none;
            z-index: 20;
            animation: effectScale 0.5s forwards;
        }

        @keyframes effectScale {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        .perfect {
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.8);
        }

        .great {
            color: #00ff99;
            text-shadow: 0 0 10px rgba(0, 255, 153, 0.8);
        }

        .good {
            color: #3399ff;
            text-shadow: 0 0 10px rgba(51, 153, 255, 0.8);
        }

        .miss {
            color: #ff6666;
            text-shadow: 0 0 10px rgba(255, 102, 102, 0.8);
        }

        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 20px;
            max-width: 80%;
            z-index: 30;
            backdrop-filter: blur(10px);
        }

        .instructions h2 {
            margin-bottom: 5px;
            color: #ffcc00;
        }

        .instructions p {
            margin: 5px 0;
            line-height: 1.0;
        }

        .instructions .highlight {
            color: #ff3366;
            font-weight: bold;
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 5px;
            background: linear-gradient(to right, #ff3366, #ffcc00);
            width: 0%;
            transition: width 0.1s linear;
            z-index: 10;
        }

        .lane {
            position: absolute;
            top: 0;
            height: 100%;
            width: 80px;
            border-left: 1px dashed rgba(255, 255, 255, 0.1);
            border-right: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .lane-0 {
            left: 10%;
        }

        .lane-1 {
            left: 25%;
        }

        .lane-2 {
            left: 40%;
        }

        .lane-3 {
            left: 55%;
        }

        .lane-4 {
            left: 70%;
        }

        .lane-5 {
            left: 85%;
        }

        .config-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 200px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 15;
        }

        .debug-info {
            position: absolute;
            bottom: 80px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 15;
        }

        .game-title {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            z-index: 5;
        }

        #enemyName {
            position: fixed;
            z-index: 9999;
            width: 100%;
            top: 2vh;
            color: #fff;
            font-size: 3vh;
            text-align: center;
            display: none;
        }

        #enemyHp {
            position: fixed;
            z-index: 9999;
            background-color: #FF002E;
            width: 80vw;
            top: 8vh;
            left: 10vw;
            margin: auto;
            height: 2vh;
            border-radius: 1vh;
            display: none;
        }

        #skills {
            position: fixed;
            z-index: 9999;
            width: 45vh;
            height: 45vh;
            bottom: 20vh;
            right: 12vh;
            /*display: none;*/
        }

        #skills>div {
            position: absolute;
            width: 8vh;
            height: 8vh;

            background-position: center center;
            background-size: cover;
        }

        #atk {
            bottom: 0;
            left: 0;
            position: absolute;
            width: 28vh;
            height: 28vh;
            background-image: url("./assets/ui/talent/150.png");
            background-position: center center;
            background-size: 75% 75%;
            background-repeat: no-repeat;
            background-color: rgb(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        #library {}
    </style>
</head>

<body>

    <section id="library" style="position: fixed;top: 0;left: 0;width: 100vw;height: 100vh;z-index: 19999;background: #fff;">
        <div id="libraryTitle" style="padding: 3vh;font-size: 150%;color: #08f;text-align: center;"> EMIT-文章标题</div>
        <div id="libraryContent" style="overflow: auto;height: 62vh;padding: 3vh;"> 文章内容 </div>
        <div>
            <div style="left: 0;right: 0;padding: 2vh;margin: auto;width: 40vw;color: #fff;background: #08f;border-radius: 2vh;" onclick="gui.library();">完成审阅</div>
        </div>
        <div style="position: fixed;top: 2vh;right: 3vh;color: red;" id="libraryBack" onclick="document.getElementById('library').style.display='none'">关闭</div>
    </section>
    <div id="playerHp">100</div>
    <div id="enemyName"></div>
    <div id="enemyHp"></div>

    <section id="unlockKeys" style="position: fixed;display: none;top: 0;left: 0;z-index: 11933;width: 100vw;height: 100vh;background-image: url('./assets/backgrounds/words.jpg');background-size: auto 100vh;background-position: center center;">
        <div id="issue" style="background-color: rgb(0,0,0,0.6);text-align: center;font-size: 120%;padding: 8vh;color: #fff;">Ques</div>
        <input id="keyInput" type="text" value="abcd" style="display: block;margin: auto;width: 70%;background: none;outline: none;border:none;border-bottom: 1px solid #fff;color: #fff;font-size: 200%;background: #08f;"> </input>
        <button onclick="UnlockKeys.confirm(document.getElementById('keyInput').value)" style="display: block;margin: auto;width: 70%;background: none;outline: none;border:none;border-bottom: 1px solid #fff;color: #08f;font-size: 200%;background: #fff;">校验</button>
        <div id="thatsCorrect" style="background-color: #fff;margin: auto;width: 70%;;outline: none;border:none;border-bottom: 1px solid #fff;"></div>
        <div style="background-color: #fff;margin: auto;width: 100%;;outline: none;border:none;border-bottom: 1px solid #fff;position: absolute;bottom: 20vh;text-align: center;" onclick="UnlockKeys.back()">关闭</div>
    </section>

    <section id="skills">
        <section id="atk" onclick="Talents.system.skill(0)"></section>
        <div id="skill1" style="top:9vh;left:-10vh;background-image: url('./assets/img/objects/hpRecover.png');" onclick="Talents.system.skill(3)"></div>
        <div id="skill2" style="top:0;left:8vh;background-image: url('./assets/ui/talent/Diamond_Sword_JE3_BE3.png');" onclick="Talents.system.skill(2)"></div>
        <div id="skill3" style="top:0vh;left: 20vh;background-image: url('./assets/materials/skill0.svg');" onclick="Talents.system.skill(4)"></div>
    </section>

    <section id="homepage" onclick="loadGame()">
        <div id="startgame">点击任意位置开始游戏</div>
        <div id="loadingtips">◇ ......系统时间的未知的坍缩也带来了记忆的碎片化浮动。</div>
    </section>

    <section id="Weici">
        <div id="wScore" style="position: fixed;top: 2vh;width: 100vw;text-align: center;color: green;font-size: 150%;font-size: 4vh;">0</div>
        <div id="wTime" style="position: fixed;top: 2vh;width: 100vw;text-align: right;color: red;padding: 30px;font-size: 4vh;">60</div>
        <div id="wWord" style="font-size: 8vh;">[Word]</div>
        <div id="wOptions">
            <div class="block">0</div>
            <div class="block">1</div>
            <div class="block">2</div>
        </div>
    </section>
    <div id="wBoard"></div>

    <section id="fps" style="position: fixed;color: red;z-index: 10009;font-size: 50%;display:none;"></section>
    
    <div id="joystick-container">
        <div id="joystick-base"></div>
        <div id="joystick-head"></div>
    </div>

    <section id="land" style="position: absolute;"></section>

    <script>
        function loadGame() {
            document.getElementById("loadingtips").style.opacity = "1";
            document.getElementById("startgame").innerText = "加载中..."
            setTimeout(() => {
                document.getElementById("homepage").style.display = "none";
                main();
            }, 1000)
        }
        //开始界面
        document.getElementById("homepage").style.backgroundImage = "url('./assets/backgrounds/img1.jpg')";

        /*setTimeout(() => {
            const music = new Audio("./assets/audio/sck.mp3");
            music.play()
        }, 3000)*/
        const imgs = ["./assets/backgrounds/img1.jpg", "./assets/backgrounds/img2.jpg"]
        let imgcount = 0;
        let waitFor = setInterval(() => {
            if (imgcount == imgs.length) imgcount = 0;
            document.getElementById("homepage").style.backgroundImage = `url(${imgs[imgcount]})`
            imgcount++
        }, 4000)
    </script>
    <script>
        let wakeLock = null;

        async function acquireWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("屏幕唤醒锁已激活");

                // 监听释放事件（可选）
                wakeLock.addEventListener('release', () => {
                    console.log("屏幕唤醒锁已释放");
                });

            } catch (err) {
                console.error(`获取唤醒锁失败: ${err.message}`);
            }
        }

        // 调用函数
        acquireWakeLock();
        //手机端

        let getHandle;
        let joystick = null;
        document.addEventListener('DOMContentLoaded', () => {

            // 正确方式：在 DOM 加载完成后执行

            joystick = {
                head: document.getElementById('joystick-head'),
                baseRect: null,
                maxDistance: 100, // 最大移动距离
                currentPos: {
                    x: 0,
                    y: 0
                },

                init() {
                    this.baseRect = document.getElementById('joystick-base').getBoundingClientRect();
                    this.addEventListeners();
                },

                addEventListeners() {
                    let isTouching = false;
                    const container = document.getElementById('joystick-container');

                    // 绑定到容器而非头部
                    container.addEventListener('touchstart', (e) => {
                        isTouching = true;
                        this.handleMove(e.touches[0]); // 立即响应初始触摸位置
                        e.preventDefault();
                    }, {
                        passive: false
                    });

                    document.addEventListener('touchmove', (e) => {
                        /**/
                        if (isTouching) {
                            this.handleMove(e.touches[0]);
                            e.preventDefault();
                            /**/
                        }
                    }, {
                        passive: false
                    });

                    document.addEventListener('touchend', () => {
                        isTouching = false;
                        this.resetPosition();
                    });
                },

                handleMove(touch) {
                    // 动态获取基准位置（避免缓存导致的偏差）
                    const base = document.getElementById('joystick-base');
                    const baseRect = base.getBoundingClientRect();

                    // 计算基座中心点
                    const centerX = baseRect.left + baseRect.width / 2;
                    const centerY = baseRect.top + baseRect.height / 2;

                    // 计算触摸点与基座中心的偏移量
                    let deltaX = touch.clientX - centerX;
                    let deltaY = touch.clientY - centerY;

                    // 限制移动范围
                    const distance = Math.sqrt(deltaX ** 2 + deltaY ** 2);
                    if (distance > this.maxDistance) {
                        deltaX = (deltaX / distance) * this.maxDistance;
                        deltaY = (deltaY / distance) * this.maxDistance;
                    }

                    // 关键修正：让头部中心对齐触摸点
                    this.head.style.transform = `
        translate(calc(-50% + ${deltaX}px), 
                  calc(-50% + ${deltaY}px))
    `;

                    // 存储标准化坐标
                    this.currentPos = {
                        x: deltaX / this.maxDistance,
                        y: deltaY / this.maxDistance
                    };
                },

                resetPosition() {
                    this.head.style.transform = 'translate(-50%, -50%)';
                    this.currentPos = {
                        x: 0,
                        y: 0
                    };
                },
                display() {
                    document.getElementById("joystick-container").style.display = "block";
                },
                hidden() {
                    document.getElementById("joystick-container").style.display = "none";
                }
            };

            // 初始化摇杆


            // 获取摇杆位置的函数
            getHandle = function() {
                return joystick.currentPos;
            }
            joystick.init();
            joystick.hidden();
        });
    </script>
    <script src="./data/positions.js"></script>
    <script src="./data/plot1.js"></script>
    <script src="./js/gui.js"></script>
    <script src='./js/render.js'></script>
    <script src="./js/index.js"></script>
    <script src="./js/weici.js"></script>
    <script src="./js/scene/unlockkeys.js"></script>
    <script src="./js/scene/musicCity.js"></script>
    <script src="./data/text.js"></script>

    <!-- <script src="./js/develop.js"></script> -->

    <script>
        let FPS = 0;
        let localFPS = 60;
        setInterval(() => {
            document.getElementById("fps").innerHTML = `FPS ${FPS}<br>Position: ${Math.round(player.position.x)},${Math.round(player.position.y)}<br>`;
            localFPS = FPS;
            FPS = 0;
        }, 1000)
    </script>

    <div id="musicAmusement" style="z-index: 39999;position: fixed;top: 0;left: 0;font-size: 3vh;background-image: linear-gradient(to bottom right, #2657eb, #de6161);display: none;">
        <div class="game-container">
            <div class="game-title">命运</div>
            <div class="progress-bar" id="progressBar"></div>

            <div class="game-header">
                <div class="score-container">得分: <span id="score">0</span></div>
                <div class="combo-container">连击: <span id="combo">0</span></div>
            </div>

            <div class="game-area" id="gameArea">
                <div class="lane lane-0"></div>
                <div class="lane lane-1"></div>
                <div class="lane lane-2"></div>
                <div class="lane lane-3"></div>
                <div class="judgment-line"></div>
            </div>

            <div class="controls">
                <button class="start-button" id="startButton">开始游戏</button>
            </div>

            <div class="instructions" id="instructions" style="font-size: 5vh;color: #fff;">
                <h2>音乐节奏游戏指南</h2>
                <p>当<span class="highlight">音符</span>到达判定线时，点击它们！</p>
                <p>根据点击时机获得不同判定：</p>
                <p><span class="perfect">PERFECT</span> - 完美时机 (+100分)</p>
                <p><span class="great">GREAT</span> - 良好 (+70分)</p>
                <p><span class="good">GOOD</span> - 还行 (+40分)</p>
                <p><span class="miss">MISS</span> - 错过 (连击中断)</p>
                <p>尽可能获得高连击获取额外分数！</p>
                <p>点击下方"开始游戏"按钮开始</p>
            </div>

            <div class="debug-info" id="debugInfo" style="display:none;">
                游戏状态: 等待开始
            </div>
        </div>
        <div id="scoreScreen" style="z-index: 40000;position:absolute;width:100vw;height:100vh;background: rgb(0,0,0,0.6);top:-150vh;left: -150vw;transition: 0.8s;">

        </div>
    </div>
    <script>
        let lock = false;
        let times = []
        requestAnimationFrame(hhh);

        function hhh(t) {
            if (lock == true) times.push(Math.round(t / 100) / 10)
            lock = false;
            requestAnimationFrame(hhh);
        }

        function asd() {
            lock = true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 游戏元素
            const gameArea = document.getElementById('gameArea');
            const startButton = document.getElementById('startButton');
            const scoreElement = document.getElementById('score');
            const comboElement = document.getElementById('combo');
            const progressBar = document.getElementById('progressBar');
            const instructions = document.getElementById('instructions');
            const debugInfo = document.getElementById('debugInfo');

            // 音符配置数组 - 确保音符会降落
            //[Max]23480,Lulu
            const noteConfigs = [{
                    position: 3,
                    time: 2.2
                }, // 位置0（最左侧轨道），1.0秒时到达判定线0.6
                {
                    position: 1,
                    time: 2.5
                },
                {
                    position: 3,
                    time: 2.8
                },
                {
                    position: 1,
                    time: 3.1
                },
                {
                    position: 3,
                    time: 3.4
                },
                {
                    position: 1,
                    time: 3.7
                },
                {
                    position: 3,
                    time: 4.0
                },
                {
                    position: 1,
                    time: 4.3
                },
                {
                    position: 3,
                    time: 4.6
                },
                {
                    position: 0,
                    time: 4.7
                },
                {
                    position: 1,
                    time: 4.8
                },
                {
                    position: 3,
                    time: 5.0
                },
                {
                    position: 0,
                    time: 5.1
                },
                {
                    position: 1,
                    time: 5.2
                },
                {
                    position: 3,
                    time: 5.3
                },
                {
                    position: 0,
                    time: 5.4
                },
                {
                    position: 1,
                    time: 5.5
                },
                {
                    position: 3,
                    time: 5.7
                },
                {
                    position: 0,
                    time: 5.8
                },
                {
                    position: 1,
                    time: 5.9
                },
                {
                    position: 2,
                    time: 6.0
                },
                {
                    position: 0,
                    time: 6.3
                },
                {
                    position: 0,
                    time: 6.6
                },
                {
                    position: 0,
                    time: 6.9
                },
                {
                    position: 4,
                    time: 7.2
                },
                {
                    position: 2,
                    time: 7.5
                },
                {
                    position: 4,
                    time: 7.8
                },
                {
                    position: 2,
                    time: 8.1
                },
                {
                    position: 4,
                    time: 8.4
                },
                {
                    position: 2,
                    time: 8.7
                },
                {
                    position: 4,
                    time: 9
                },
                {
                    position: 2,
                    time: 9.3
                },
                {
                    position: 5,
                    time: 9.6
                },
                {
                    position: 3,
                    time: 9.9
                },
                {
                    position: 5,
                    time: 10.2
                },
                {
                    position: 3,
                    time: 10.5
                },
                {
                    position: 5,
                    time: 10.8
                },
                {
                    position: 3,
                    time: 11.3
                },
                {
                    position: 5,
                    time: 11.6
                },
                {
                    position: 3,
                    time: 11.9
                },
                {
                    position: 1,
                    time: 12.0
                },
                {
                    position: 3,
                    time: 12.2
                },
                {
                    position: 3,
                    time: 12.3
                },
                {
                    position: 2,
                    time: 12.5
                },
                {
                    position: 1,
                    time: 14.5
                },
                {
                    position: 3,
                    time: 14.7
                },
                {
                    position: 3,
                    time: 14.8
                },
                {
                    position: 2,
                    time: 15.0
                },
                {
                    position: 1,
                    time: 17.2
                },
                {
                    position: 4,
                    time: 17.5
                },
                {
                    position: 2,
                    time: 17.9
                },
                {
                    position: 4,
                    time: 18.1
                },
                {
                    position: 6,
                    time: 18.3
                },
                {
                    position: 5,
                    time: 18.5
                },
                {
                    position: 4,
                    time: 18.7
                },
                {
                    position: 3,
                    time: 19.3
                },
                {
                    position: 1,
                    time: 19.6
                },
                {
                    position: 2,
                    time: 19.9
                },
                {
                    position: 1,
                    time: 20.3
                },
                {
                    position: 4,
                    time: 20.6
                },
                {
                    position: 2,
                    time: 21
                },
                {
                    position: 5,
                    time: 21.7
                },
                {
                    position: 3,
                    time: 21.9
                },
                {
                    position: 3,
                    time: 22.1
                },
                {
                    position: 1,
                    time: 22.3
                },
                {
                    position: 1,
                    time: 23.0
                },
                {
                    position: 1,
                    time: 24
                },
                {
                    position: 2,
                    time: 25
                },
                {
                    position: 1,
                    time: 26
                },
                {
                    position: 5,
                    time: 27
                },
                {
                    position: 0,
                    time: 28
                },
                {
                    position: 2,
                    time: 29
                },
                {
                    position: 4,
                    time: 30
                },
                {
                    position: 0,
                    time: 31
                },
                {
                    position: 0,
                    time: 32
                },
                {
                    position: 3,
                    time: 32.2
                },
                {
                    position: 3,
                    time: 32.3
                },
                {
                    position: 3,
                    time: 32.4
                },
                {
                    position: 3,
                    time: 32.5
                },
                {
                    position: 1,
                    time: 32.6
                },
                {
                    position: 2,
                    time: 32.7
                },
                {
                    position: 3,
                    time: 32.8
                },
                {
                    position: 1,
                    time: 33
                },
                {
                    position: 2,
                    time: 33.6
                },
                {
                    position: 0,
                    time: 35
                },
                {
                    position: 3,
                    time: 35.2
                },
                {
                    position: 3,
                    time: 35.3
                },
                {
                    position: 3,
                    time: 35.4
                },
                {
                    position: 3,
                    time: 35.5
                },
                {
                    position: 1,
                    time: 35.6
                },
                {
                    position: 2,
                    time: 35.7
                },
                {
                    position: 3,
                    time: 35.8
                },
                {
                    position: 0,
                    time: 39
                },
                {
                    position: 3,
                    time: 39.2
                },
                {
                    position: 3,
                    time: 39.3
                },
                {
                    position: 3,
                    time: 39.4
                },
                {
                    position: 3,
                    time: 39.5
                },
                {
                    position: 1,
                    time: 39.6
                },
                {
                    position: 2,
                    time: 39.7
                },
                {
                    position: 3,
                    time: 39.8
                },
                {
                    position: 0,
                    time: 42.5
                },
                {
                    position: 3,
                    time: 42.7
                },
                {
                    position: 3,
                    time: 42.8
                },
                {
                    position: 3,
                    time: 42.9
                },
                {
                    position: 3,
                    time: 43
                },
                {
                    position: 1,
                    time: 43.2
                },
                {
                    position: 2,
                    time: 43.3
                },
                {
                    position: 3,
                    time: 43.3
                },
                {
                    position: 0,
                    time: 45
                },
                {
                    position: 3,
                    time: 45.2
                },
                {
                    position: 3,
                    time: 45.3
                },
                {
                    position: 3,
                    time: 45.4
                },
                {
                    position: 3,
                    time: 45.5
                },
                {
                    position: 1,
                    time: 45.7
                },
                {
                    position: 2,
                    time: 45.9
                },
                {
                    position: 3,
                    time: 46.1
                },
                {
                    position: 0,
                    time: 51
                },
                {
                    position: 3,
                    time: 51.2
                },
                {
                    position: 3,
                    time: 51.3
                },
                {
                    position: 3,
                    time: 51.4
                },
                {
                    position: 3,
                    time: 51.5
                },
                {
                    position: 1,
                    time: 51.7
                },
                {
                    position: 2,
                    time: 51.9
                },
                {
                    position: 3,
                    time: 51.1
                },
                {
                    position: 0,
                    time: 53
                },
                {
                    position: 3,
                    time: 53.2
                },
                {
                    position: 3,
                    time: 53.3
                },
                {
                    position: 3,
                    time: 53.4
                },
                {
                    position: 3,
                    time: 53.5
                },
                {
                    position: 1,
                    time: 53.7
                },
                {
                    position: 2,
                    time: 53.9
                },
                {
                    position: 3,
                    time: 53.1
                },
                {
                    position: 0,
                    time: 55
                },
                {
                    position: 3,
                    time: 55.2
                },
                {
                    position: 3,
                    time: 55.3
                },
                {
                    position: 3,
                    time: 55.4
                },
                {
                    position: 3,
                    time: 55.5
                },
                {
                    position: 1,
                    time: 55.7
                },
                {
                    position: 2,
                    time: 55.9
                },
                {
                    position: 3,
                    time: 55.1
                },
                {
                    position: 0,
                    time: 57
                },
                {
                    position: 3,
                    time: 60.2
                },
                {
                    position: 3,
                    time: 60.3
                },
                {
                    position: 3,
                    time: 60.4
                },
                {
                    position: 3,
                    time: 60.5
                },
                {
                    position: 1,
                    time: 60.7
                },
                {
                    position: 2,
                    time: 60.9
                },
                {
                    position: 3,
                    time: 60.1
                },
                {
                    position: 0,
                    time: 59
                },
                {
                    position: 3,
                    time: 63.2
                },
                {
                    position: 3,
                    time: 63.3
                },
                {
                    position: 3,
                    time: 63.4
                },
                {
                    position: 3,
                    time: 63.5
                },
                {
                    position: 1,
                    time: 63.7
                },
                {
                    position: 2,
                    time: 63.9
                },
                {
                    position: 3,
                    time: 63.1
                },
                {
                    position: 1,
                    time: 64
                }, {
                    position: 2,
                    time: 65
                }, {
                    position: 3,
                    time: 66
                }, {
                    position: 4,
                    time: 67
                },
                {
                    position: 5,
                    time: 68
                }, {
                    position: 0,
                    time: 69
                }, {
                    position: 2,
                    time: 69.5
                }, {
                    position: 5,
                    time: 70
                }, {
                    position: 1,
                    time: 70.3
                }, {
                    position: 2,
                    time: 70.6
                }, {
                    position: 1,
                    time: 70.9
                }, {
                    position: 4,
                    time: 72
                }, {
                    position: 1,
                    time: 72.1
                },
                {
                    position: 0,
                    time: 82.7
                }, {
                    position: 1,
                    time: 83
                }, {
                    position: 2,
                    time: 74.3
                }, {
                    position: 3,
                    time: 74.6
                }, {
                    position: 4,
                    time: 74.9
                }, {
                    position: 5,
                    time: 75.2
                },
                {
                    position: 2,
                    time: 76
                }, {
                    position: 2,
                    time: 77
                }, {
                    position: 2,
                    time: 78
                }, {
                    position: 2,
                    time: 79
                }, {
                    position: 2,
                    time: 80
                },
                {
                    position: 1,
                    time: 84
                }, {
                    position: 1,
                    time: 85
                }, {
                    position: 1,
                    time: 86
                }, {
                    position: 1,
                    time: 87
                }, {
                    position: 5,
                    time: 88
                }, {
                    position: 1,
                    time: 88.4
                }, {
                    position: 3,
                    time: 88.5
                }, {
                    position: 2,
                    time: 88.8
                }, {
                    position: 3,
                    time: 89.1
                }, {
                    position: 1,
                    time: 90
                },
                {
                    position: 0,
                    time: 91
                },
                {
                    position: 5,
                    time: 91.3
                }, {
                    position: 3,
                    time: 91.6
                }, {
                    position: 4,
                    time: 91.9
                },
                {
                    position: 1,
                    time: 92.2
                }, {
                    position: 3,
                    time: 92.5
                }, {
                    position: 2,
                    time: 92.8
                },
                {
                    position: 1,
                    time: 93.1
                },
                {
                    position: 0,
                    time: 94.5
                }, {
                    position: 1,
                    time: 94.8
                }, {
                    position: 2,
                    time: 95.1
                }, {
                    position: 4,
                    time: 95.3
                },
                {
                    position: 5,
                    time: 96
                }, {
                    position: 4,
                    time: 96.3
                }, {
                    position: 0,
                    time: 97
                }, {
                    position: 5,
                    time: 98
                },
                {
                    position: 2,
                    time: 100
                }, {
                    position: 1,
                    time: 103
                }, {
                    position: 0,
                    time: 106
                }, {
                    position: 1,
                    time: 109
                },
                {
                    position: 5,
                    time: 112
                }, {
                    position: 4,
                    time: 114
                }, {
                    position: 3,
                    time: 115
                }, {
                    position: 2,
                    time: 118
                },
                {
                    position: 5,
                    time: 119
                }, {
                    position: 5,
                    time: 119.2
                }, {
                    position: 4,
                    time: 119.4
                }, {
                    position: 4,
                    time: 119.6
                },
                {
                    position: 0,
                    time: 119.8
                }, {
                    position: 2,
                    time: 119
                }, {
                    position: 5,
                    time: 119.2
                }, {
                    position: 4,
                    time: 119.4
                },
                {
                    position: 1,
                    time: 119.6
                }, {
                    position: 5,
                    time: 119
                }, {
                    position: 5,
                    time: 119.2
                }, {
                    position: 4,
                    time: 119.4
                }, {
                    position: 4,
                    time: 119.6
                },
                {
                    position: 0,
                    time: 119.8
                }, {
                    position: 2,
                    time: 122
                }, {
                    position: 5,
                    time: 122.2
                }, {
                    position: 4,
                    time: 122.4
                },
                {
                    position: 1,
                    time: 122.6
                },
                {
                    position: 0,
                    time: 125
                },
                {
                    position: 5,
                    time: 128
                },
                {
                    position: 3,
                    time: 133
                }
            ];

            // 游戏状态
            let gameActive = false;
            let score = 0;
            let combo = 0;
            let maxCombo = 0;
            let notes = [];
            let audioElement;
            let animationFrameId;
            let gameStartTime;
            let generatedNotes = new Set();

            // 游戏配置 - 确保音符能正确降落
            const config = {
                judgmentLinePosition: 0.80, // 判定线位置 (屏幕高度的80%处)
                perfectThreshold: 315, // PERFECT判定阈值 (ms)
                greatThreshold: 450, // GREAT判定阈值 (ms)
                goodThreshold: 675, // GOOD判定阈值 (ms)
                laneWidth: 100, // 轨道宽度
                noteSize: 90, // 音符大小
                // 轨道位置 (百分比)
                lanePositions: [
                    window.innerWidth * 0.10,
                    window.innerWidth * 0.25,
                    window.innerWidth * 0.40,
                    window.innerWidth * 0.55,
                    window.innerWidth * 0.70,
                    window.innerWidth * 0.85
                ]
            };

            // 初始化游戏
            function initGame() {
                gameArea.innerHTML = `
                    <div class="lane lane-0"></div>
                    <div class="lane lane-1"></div>
                    <div class="lane lane-2"></div>
                    <div class="lane lane-3"></div>
                    <div class="lane lane-4"></div>
                    <div class="lane lane-5"></div>
                    <div class="judgment-line"></div>
                `;
                score = 0;
                combo = 0;
                maxCombo = 0;
                notes = [];
                generatedNotes.clear();
                scoreElement.textContent = '0';
                comboElement.textContent = '0';
                progressBar.style.width = '0%';
                debugInfo.textContent = "游戏状态: 等待开始";
            }

            // 开始游戏
            function startGame() {
                if (gameActive) return;

                initGame();
                gameActive = true;
                instructions.style.display = 'none';
                startButton.textContent = '重新开始';
                startButton.style.display = "none";
                startButton.onclick = resetGame;
                debugInfo.textContent = "游戏状态: 进行中";

                // 创建音频元素
                if (audioElement) {
                    audioElement.remove();
                }

                audioElement = new Audio();
                // 使用一个可公开访问的示例音乐文件
                audioElement.src = './assets/audio/fate.mp3';
                audioElement.preload = 'auto';

                // 开始播放音乐
                audioElement.play().then(() => {
                    gameStartTime = Date.now();
                    debugInfo.textContent = "游戏状态: 音乐播放中";
                    gameLoop();
                }).catch(err => {
                    /*console.error('播放音乐失败:', err);
                    debugInfo.textContent = "错误: 无法播放音乐";
                    alert('无法播放音乐，请确保音乐文件存在。');*/
                    resetGame();
                });

                audioElement.addEventListener("ended", () => {
                    computeScore();
                }, {
                    once: true
                })

            }

            // 创建音符（基于配置）- 修复了位置计算错误
            function createNoteFromConfig() {
                if (!gameActive) return;

                const now = Date.now();
                const elapsed = now - gameStartTime;

                // 检查配置数组中需要生成的音符
                noteConfigs.forEach((noteConfig, index) => {
                    if (generatedNotes.has(index)) return;

                    // 音符生成时间 (提前800ms让玩家有反应时间)
                    const noteTime = noteConfig.time * 1000 - 900;

                    if (elapsed >= noteTime) {
                        generatedNotes.add(index);

                        const note = document.createElement('div');
                        note.className = 'note';

                        // 设置音符位置（基于轨道位置）- 修复位置计算
                        const laneIndex = noteConfig.position;
                        // 正确计算音符位置
                        const lanePosition = config.lanePositions[laneIndex];
                        const left = lanePosition /* - config.noteSize/2;*/
                        note.style.left = `${left}px`;

                        // 初始位置在屏幕上方
                        note.style.top = '-70px';

                        // 音符类型
                        const noteTypes = ['', '', '', ''];
                        const noteType = noteTypes[laneIndex % noteTypes.length];

                        note.innerHTML = `<div class="note-inner">${noteType}</div>`;
                        gameArea.appendChild(note);

                        // 存储音符信息
                        const noteObj = {
                            element: note,
                            lane: laneIndex,
                            targetTime: noteConfig.time * 1000, // 目标时间（到达判定线的时间）
                            spawnTime: now, // 生成时间
                            hit: false
                        };

                        notes.push(noteObj);
                        debugInfo.textContent = `生成音符: 轨道${laneIndex}, 时间${noteConfig.time}s`;
                    }
                });
            }

            // 游戏主循环 - 确保音符会降落
            function gameLoop() {
                if (!gameActive) return;

                const now = Date.now();
                const elapsedTime = now - gameStartTime;

                // 更新进度条
                if (audioElement.duration) {
                    const progress = (elapsedTime / (audioElement.duration * 1000)) * 100;
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                }

                // 创建音符
                createNoteFromConfig();

                // 更新音符位置 - 确保音符会移动
                notes.forEach((noteObj, index) => {
                    if (noteObj.hit) return;

                    const note = noteObj.element;
                    const startTop = -70;
                    const targetTop = window.innerHeight * config.judgmentLinePosition;

                    // 计算音符应该下落的位置
                    const elapsedSinceSpawn = now - noteObj.spawnTime;
                    const timeToTarget = noteObj.targetTime - (noteObj.spawnTime - gameStartTime);
                    const fallProgress = Math.min(elapsedSinceSpawn / timeToTarget, 1);

                    const currentTop = startTop + (targetTop - startTop) * fallProgress;
                    note.style.top = `${currentTop}px`;

                    // 如果音符已经通过判定线且未被击中
                    if (currentTop > targetTop - 15) {
                        note.remove();

                        noteObj.hit = true;
                        showJudgmentEffect(note, 'miss');
                        resetCombo();
                        debugInfo.textContent = `错过音符: 轨道${noteObj.lane}`;
                    }
                });

                // 清理已击中和已通过判定线的音符
                notes = notes.filter(noteObj => {
                    if (noteObj.hit) {
                        return false;
                    }

                    const noteRect = noteObj.element.getBoundingClientRect();
                    const belowScreen = noteRect.top > window.innerHeight;

                    return !belowScreen;
                });

                // 继续游戏循环
                animationFrameId = requestAnimationFrame(gameLoop);
            }

            // 显示判定效果
            function showJudgmentEffect(note, judgment) {
                const rect = note.getBoundingClientRect();
                const effect = document.createElement('div');
                effect.className = `judgment-effect ${judgment}`;
                effect.textContent = judgment.toUpperCase();
                effect.style.left = `${rect.left + rect.width/2 - 20}px`;
                effect.style.top = `${rect.top + rect.height/2 - 20}px`;

                gameArea.appendChild(effect);

                // 效果结束后移除
                setTimeout(() => {
                    if (effect.parentNode) {
                        effect.parentNode.removeChild(effect);
                    }
                }, 600);
            }

            // 处理音符点击
            function handleNoteHit(noteObj) {
                if (noteObj.hit) return;

                const now = Date.now();
                const targetTime = gameStartTime + noteObj.targetTime;
                const elapsed = now - targetTime; // 击中时间与目标时间的差值
                const absElapsed = Math.abs(elapsed);

                let judgment;
                let points = 0;

                if (absElapsed <= config.perfectThreshold) {
                    judgment = 'perfect';
                    points = 100;
                } else if (absElapsed <= config.greatThreshold) {
                    judgment = 'great';
                    points = 70;
                } else if (absElapsed <= config.goodThreshold) {
                    judgment = 'good';
                    points = 40;
                } else {
                    judgment = 'miss';
                    resetCombo();
                }

                if (judgment !== 'miss') {
                    combo++;
                    comboElement.textContent = combo;
                    maxCombo = Math.max(maxCombo, combo);

                    // 连击奖励
                    if (combo % 10 === 0) {
                        const bonus = combo * 5;
                        points += bonus;
                    }

                    addScore(points);
                }

                noteObj.hit = true;
                noteObj.element.remove();
                showJudgmentEffect(noteObj.element, judgment);
                debugInfo.textContent = `击中: ${judgment.toUpperCase()} (+${points})`;
            }

            // 添加分数
            function addScore(points) {
                score += points;
                scoreElement.textContent = score;
            }

            // 重置连击
            function resetCombo() {
                combo = 0;
                comboElement.textContent = '0';
            }

            // 重置游戏
            function resetGame() {

                gameActive = false;

                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }

                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                instructions.style.display = 'block';
                startButton.textContent = '开始游戏';
                debugInfo.textContent = "游戏状态: 已结束";
                startGame();
            }

            // 事件监听器
            startButton.onclick = startGame;
            //startButton.addEventListener('click', startGame);

            // 触摸事件处理 - 确保能点击音符
            gameArea.addEventListener('touchstart', (e) => {
                if (!gameActive) return;

                e.preventDefault();

                const touch = e.touches[0];
                const touchX = touch.clientX;
                const touchY = touch.clientY;

                // 检查触摸点是否在音符上
                let hitNote = false;

                notes.forEach(noteObj => {
                    if (noteObj.hit) return;

                    const noteRect = noteObj.element.getBoundingClientRect();

                    // 简单的边界框碰撞检测
                    if (touchX >= noteRect.left &&
                        touchX <= noteRect.right &&
                        touchY >= noteRect.top &&
                        touchY <= noteRect.bottom) {
                        handleNoteHit(noteObj);
                        hitNote = true;
                    }
                });

                if (!hitNote) {
                    debugInfo.textContent = "未击中任何音符";
                    resetCombo();
                }
            });

            function computeScore() {

                if (Status.para.score < score) {
                    Status.para.score = score
                }

                document.getElementById("scoreScreen").style.left = "0";
                document.getElementById("scoreScreen").style.top = "0";
                document.getElementById("scoreScreen").innerHTML = `
                    <div style="position: absolute;width: 78vh;height: 78vh;color: #fff;text-align: center;left: 0;right: 0;top:10vh;botttom: 0;margin: auto;background-color: rgb(0,0,0,0.82);padding: 5vh;">
                        <h3>分数</h3>
                        <br>
                        <h1>${score}</h1>
                        <div></div>
                        <br>
                        <div id="resetGameBtn" style="color: #08f;border: 1px solid #fff;border-radius: 3vh;padding: 8px;">重新开始弹奏</div><br>
                        <div style="color: #A2AEFF;border: 1px solid #fff;border-radius: 3vh;padding: 8px;" onclick="MusicCityNextPhase()">查看钢琴下的异响</div>
                    </div>
                `
                document.getElementById("resetGameBtn").onclick = () => {
                    resetGame();
                    document.getElementById("scoreScreen").style.left = "-150vw";
                    document.getElementById("scoreScreen").style.top = "-150vh";
                }


            }

            // 防止移动端下拉刷新
            document.body.addEventListener('touchmove', (e) => {
                if (gameActive) {
                    e.preventDefault();
                }
            }, {
                passive: false
            });

            // 初始化游戏
            initGame();
        });
    </script>


</body>

</html>